# 24.4 网络防火墙配置
前面我们讲解了 iptables 命令的使用，其中主要是以配置主机防火墙作为示例，本节将来介绍如何配置一个网络防火墙。iptables 命令的使用没变，只是网络防火墙配置载 forward 链上有一些额外注意的事项。

# 1. 网络防火墙配置
在进行网络防火墙配置之前，我们首先需要规划一下网络拓扑结构，好方便解说 iptables 命令的作用。

![network](../images/23/net_filter.jpg)

## 1.1 放行 httpd


## 1.2 基于连接追踪机制配置


## 2. 利用 iptables 抵御 DOS 攻击
利用iptables的recent模块来抵御DOS攻击:
1. 建立一个列表，保存有所有访问过指定的服务的客户端IP
2. ssh: 远程连接，

```
# one
> iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 3 -j DROP

# two
> iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --set --name SSH

# three
> iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j LOG --log-prefix "SSH Attach: "

# four
> iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j DROP

# 也可以使用下面的这句记录日志：
> iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --name SSH --second 300 --hitcount 3 -j LOG --log-prefix "SSH Attack"
```

1. one:
2. two:
- 利用connlimit模块将单IP的并发设置为3；会误杀使用NAT上网的用户，可以根据实际情况增大该值；
    - 第二句是记录访问tcp 22端口的新连接，记录名称为SSH
    - --set 记录数据包的来源IP，如果IP已经存在将更新已经存在的条目
3. three
    - 利用recent和state模块限制单IP在300s内只能与本机建立2个新连接。被限制五分钟后即可恢复访问。
4. four:
    - 第三句是指SSH记录中的IP，300s内发起超过3次连接则拒绝此IP的连接。
    - --update 是指每次建立连接都更新列表；
    - --seconds必须与--rcheck或者--update同时使用
    - --hitcount必须与--rcheck或者--update同时使用
5. 附注:
    - iptables的记录：/proc/net/xt_recent/SSH
