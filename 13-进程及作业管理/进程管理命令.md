# 13.2 进程管理命令
Linux系统上有众多进程查看及管理工具，不完全列示如下:
1. 进程查看命令: pstree, ps, pidof, pgrep
2. 进程管理命令: kill, pkill, killall，nice, renice
2. 实时动态命令: top, htop, glances, pmap, vmstat, dstat,
3. 作业管理: job, bg, fg, nohup

这些命令在我们以后的运维过程中都能用到，希望大家能熟练掌握。

## 1. 进程查看
### 1.1 pstree
`pstree options`
- 作用: 以树状图的方式展现进程之间的派生关系
- 选项:
    - `-p`: 显示程序 pid；
    - `-u`: 显示用户名称；
    - `-n`: 用 pid 排序,预设是以程序名称来排序；
    - `-a`: 显示每个程序的完整指令，包含路径，参数或是常驻服务的标示；
    - `-c`: 不使用精简标示法；
    - `-G`: 使用VT100终端机的列绘图字符；
    - `-h`: 列出树状图时，特别标明现在执行的程序；
    - `-H<pid>`: 此参数的效果和指定"-h"参数类似，但特别标明指定的程序；
    - `-l`: 采用长列格式显示树状图；
    - `-U`: 使用UTF-8列绘图字符；
    - `-V`: 显示版本信息


### 1.2 ps
#### ps 命令简介
在前面的 [4.1 Linux目录机构](04-Linux根文件系统和目录结构及bash特性/Linux目录结构.md) 我们提到过，Linux 有两个伪文件系统 `/proc`,`/sys`
- `/proc/`:
  - 是基于内存的虚拟文件系统，保存了内核及进程的相关信息；
  - `/proc` 内的内核参数分为两类:
    1. 状态变量: 其用于输出内核中统计信息或状态信息，仅用于查看
    2. 可设置其值从而调整内核运行特性的参数,位于 `/proc/sys/`，例如`net.ipv4.ip_forward`, 虚拟为`net/ipv4/ip_forward`, 存储于`/proc/sys/`, 因此其完整路径为/proc/sys/net/ipv4/ip_forward；
- `/sys/`:
    - 用于挂载sysfs虚拟文件系统
    - 提供了一种比proc更为理想的访问内核数据的途径
    - 其主要作用在于为**管理Linux设备**提供一种统一模型的的接口；

Linux 进程的各种状态信息保存在 `/proc` 中以进程 PID 号命名的文件中。ps 命令即是通过读取 `/proc/PID` 目录内的文件，显示进程的相关信息。ps 命令选项有三种风格:
1. UNIX 风格的参数，必需使用 `-`
2. BSD 风格的参数, 不能使用 `-`
3. GNU 风格的长选项, 使用`--`开头


#### ps 使用
`ps [options]`:
- 作用: report a snapshot of the current processes.
- BSD 选项:
    - `a`: 所有与终端相关的进程；
    - `x`: 所有与终端无关的进程；
    - `u`: 以用户为中心组织进程状态信息显示；
    - `U<uname>`: 显示特定用户进程   
    - `-o/o field1, field2,...`:
        - 可以加 `-` 也可以不加
        - 用于自定义要显示的字段列表，字段列表以逗号分隔；
        - 常用的field: `pid, ni, pri, psr, pcpu, stat, comm, tty, ppid, rtprio`
- UNIX 选项:
    - `-e`: 显示所有进程
    - `-f`: 显示完整格式的进程信息
    - `-F`: 显示完整格式的进程信息，与 `-f` 显示的字段略不同
    - `-H`: 以层级结构显示进程的相关信息；  
    - `-U<uid>`: 显示特定用户进程
    - `-u<uid>`: 显示特定用户进程
- 常用组合之一:
    - `ps aux`
    - `ps -ef`
    - `ps -eFH`
    - `ps -eo`, `ps axo`

#### `ps aux`
```
tao@hp:~$ ps aux |head -10
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.1 194436  9136 ?        Ss   08:49   0:03 /usr/lib/systemd/systemd --switched-root --system --deserialize 21
root         2  0.0  0.0      0     0 ?        S    08:49   0:00 [kthreadd]
root         3  0.0  0.0      0     0 ?        S    08:49   0:00 [ksoftirqd/0]
root         5  0.0  0.0      0     0 ?        S<   08:49   0:00 [kworker/0:0H]
root         7  0.0  0.0      0     0 ?        S    08:49   0:03 [rcu_sched]
root         8  0.0  0.0      0     0 ?        S    08:49   0:00 [rcu_bh]
root         9  0.0  0.0      0     0 ?        S    08:49   0:01 [rcuos/0]
root        10  0.0  0.0      0     0 ?        S    08:49   0:00 [rcuob/0]
root        11  0.0  0.0      0     0 ?        S    08:49   0:00 [migration/0]
```
- `%CPU`: CPU 占用百分比
- `%MEM`: 内存占用百分比
- `VSZ`: 虚拟内存集；
- `RSS`: Resident Size，常驻内存集；
- `TTY`: 进程所属终端
- `STAT`: 进程状态
    - `R:` running，运行中  
    - `S:` interruptable sleeping，可中断睡眠  
    - `D:` uninterruptable sleeping，不可中断睡眠
    - `T:` Stopped，停止状态
    - `Z:` zombie，僵尸进程
    - `+:` 前台进程
    - `l:` 多线程进程
    - `N:` 低优先级进程
    - `<:` 高优先级进程
    - `s:` session leader，管理着多个其他进程的进程
- `START`: 开始运行时间
- `TIME`: 进程累积实际使用CPU时间片之和

#### `ps -ef`
```
tao@hp:~$ ps -ef|head -10
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 08:49 ?        00:00:04 /usr/lib/systemd/systemd --switched-root --system --deserialize 21
root         2     0  0 08:49 ?        00:00:00 [kthreadd]
root         3     2  0 08:49 ?        00:00:00 [ksoftirqd/0]
root         5     2  0 08:49 ?        00:00:00 [kworker/0:0H]
root         7     2  0 08:49 ?        00:00:03 [rcu_sched]
root         8     2  0 08:49 ?        00:00:00 [rcu_bh]
```
- `PPID`: 父进程的 pid
- `C`: cpu utilization, CPU 占用率
- `STIME`: 开始运行时间
- `TIME`: 进程累积实际使用CPU时间片之和

#### `ps -eFH`
```
tao@hp:~$ ps -eFH|head -10
UID        PID  PPID  C    SZ   RSS PSR STIME TTY          TIME CMD
root         2     0  0     0     0   2 08:49 ?        00:00:00 [kthreadd]
root         3     2  0     0     0   0 08:49 ?        00:00:00   [ksoftirqd/0]
root         5     2  0     0     0   0 08:49 ?        00:00:00   [kworker/0:0H]
root         7     2  0     0     0   3 08:49 ?        00:00:03   [rcu_sched]
root         8     2  0     0     0   0 08:49 ?        00:00:00   [rcu_bh]
```
- `C`: cpu utilization, CPU 占用率
- `SZ`: VSZ 虚拟内存集；
- `RSS`: Resident Size，常驻内存集；
- `PSR`: 进程运行于哪颗CPU之上
- `STIME`: 开始运行时间
- `TIME`: 进程累积实际使用CPU时间片之和

#### `ps -eo|axo`
```
tao@hp:~$ ps -eo user,uid,nice,priority,psr,pcpu,stat,rtprio,cmd,tty,ppid
USER       UID  NI PRI PSR %CPU STAT RTPRIO CMD                         TT        PPID
root         0   0  20   0  0.0 Ss        - /usr/lib/systemd/systemd -- ?            0
root         0   0  20   2  0.0 S         - [kthreadd]                  ?            0
root         0   0  20   0  0.0 S         - [ksoftirqd/0]               ?            2
root         0 -20   0   0  0.0 S<        - [kworker/0:0H]              ?            2
root         0   0  20   0  0.0 S         - [rcu_sched]                 ?            2
root         0   0  20   0  0.0 S         - [rcu_bh]                    ?            2
root         0   0  20   2  0.0 S         - [rcuos/0]                   ?            2
root         0   0  20   0  0.0 S         - [rcuob/0]                   ?            2
root         0   - -100  0  0.0 S        99 [migration/0]               ?            2
```
`ps -eo user, uid, nice, priority, psr, pcpu, stat, rtprio, cmd, tty, ppid`
- `ni/nice`: nice值
- `priority`: priority, 优先级
- `psr`: PSR 进程运行于哪颗CPU之上
- `pcpu`: %CPU cpu 占用百分比
- `stat`: STAT 进程状态
- `rtprio`: real time priority，实时优先级

### 1.3 pgrep
`pgrep [options] pattern`
- 作用: 通过进程名或其他属性查找进程
- 参数: pattern 匹配进程名的模式
- 选项  
    - `-l`: 显示进程名；
    - `-a`: 显示完整格式的进程名；
    - `-u uid`: effective user，有效用户  
    - `-U uid`: real user，实际用户
    - `-t TERMINAL`: 与指定的终端相关的进程；
    - `-P pid`: 显示此进程的子进程；
    - `-o`：仅显示找到的最小（起始）进程号；
    - `-n`：仅显示找到的最大（结束）进程号；

```
tao@hp:~$ pgrep -la htt*
13163 /usr/sbin/httpd -DFOREGROUND
13169 /usr/sbin/httpd -DFOREGROUND
13172 /usr/sbin/httpd -DFOREGROUND
13173 /usr/sbin/httpd -DFOREGROUND
13177 /usr/sbin/httpd -DFOREGROUND
13178 /usr/sbin/httpd -DFOREGROUND
13180 /usr/sbin/httpd -DFOREGROUND
```

### 1.4 pidof命令:
`pidof [options] program [program..]`
- 作用: 根据进程名，取其进程 pid
- 参数: program 进程名称
- 选项:
  - `-s`：仅返回一个进程号；

```
tao@hp:~$ pidof httpd
13180 13178 13177 13173 13172 13169 13163
```

## 2. 进程管理
nice 命令可以调整进程 nice 值，进而调整进程优先级,kill 类命令可以向进程发送信号，以实现对进程管理。Linux 中每个信号的标识方法有三种:
1. 信号的数字标识；
2. 信号的完整名称；
3. 信号的简写名称；

```
#  HUP = SIGHUP = 1
tao@hp:monitor$ kill -l 1
HUP
tao@hp:monitor$ kill -l SIGHUP
1
```

### 2.1 kill
#### 查看信号类型
`kill -l [signal]`
- 作用: 查看信号类型           
- 参数: `signal` 待查看的信号类型，可选，默认显示所有信号
- 常用信号:

```
tao@hp:monitor$ kill -l
 1) SIGHUP	 2) SIGINT	 3) SIGQUIT	 4) SIGILL	 5) SIGTRAP
 6) SIGABRT	 7) SIGBUS	 8) SIGFPE	 9) SIGKILL	10) SIGUSR1
11) SIGSEGV	12) SIGUSR2	13) SIGPIPE	14) SIGALRM	15) SIGTERM
16) SIGSTKFLT	17) SIGCHLD	18) SIGCONT	19) SIGSTOP	20) SIGTSTP
21) SIGTTIN	22) SIGTTOU	23) SIGURG	24) SIGXCPU	25) SIGXFSZ
26) SIGVTALRM	27) SIGPROF	28) SIGWINCH	29) SIGIO	30) SIGPWR
31) SIGSYS	34) SIGRTMIN	35) SIGRTMIN+1	36) SIGRTMIN+2	37) SIGRTMIN+3
38) SIGRTMIN+4	39) SIGRTMIN+5	40) SIGRTMIN+6	41) SIGRTMIN+7	42) SIGRTMIN+8
43) SIGRTMIN+9	44) SIGRTMIN+10	45) SIGRTMIN+11	46) SIGRTMIN+12	47) SIGRTMIN+13
48) SIGRTMIN+14	49) SIGRTMIN+15	50) SIGRTMAX-14	51) SIGRTMAX-13	52) SIGRTMAX-12
53) SIGRTMAX-11	54) SIGRTMAX-10	55) SIGRTMAX-9	56) SIGRTMAX-8	57) SIGRTMAX-7
58) SIGRTMAX-6	59) SIGRTMAX-5	60) SIGRTMAX-4	61) SIGRTMAX-3	62) SIGRTMAX-2
63) SIGRTMAX-1	64) SIGRTMAX

tao@hp:monitor$ kill -l 1
HUP
tao@hp:monitor$ kill -l SIGHUP
1
```

#### 发送信号管理进程
`kill  [-s signal|-SIGNAL]  pid...`
- 作用: 用于向进程发送信号，以实现对进程的管理
- 选项:
    - `-s signal|-SIGNAL`: 指明要发送的信号
    - `-p`：指定kill 命令只打印相关进程的进程号，而不发送任何信号；
    - `-u`：指定用户
- 常用信号:
    - `1） SIGHUP`: 无须关闭进程而让其重读配置文件；
    - `2）SIGINT`: 终止正在运行的进程，相当于Ctrl+c
    - `9）SIGKILL`: 杀死运行中的进程；
    - `15）SIGTERM`: 终止运行中的进程；
    - `18）SIGCONT`: 启动暂停的进程
    - `19）SIGSTOP`: 暂停进程

```
kill -9 1999
kill -s 9 1999
kill -SIGKILL 1999
kill -KILL 1999
```

### 2.2 killall
`killall  [-SIGNAL]  program`
- 作用: 使用进程的名称来杀死进程，使用此指令可以杀死一组同名进程
- 参数: program 进程名称
- 选项:
    - `-e`：对长名称进行精确匹配；
    - `-l`：忽略大小写的不同；
    - `-p`：杀死进程所属的进程组；
    - `-i`：交互式杀死进程，杀死进程前需要进行确认；
    - `-l`：打印所有已知信号列表；
    - `-q`：如果没有进程被杀死。则不输出任何信息；
    - `-r`：使用正规表达式匹配要杀死的进程名称；
    - `-s signal|-SIGNAL`：指定发送的信号
    - `-u`：杀死指定用户的进程。

### 2.3 pkill
`pkill [options] pattern`
- 作用: 通过进程名或其他属性向进程发送信号，用法与 pgrep 类似
- 选项:
    - `-u uid`: effective user，向指定的有效用户发送信号  
    - `-U uid`: real user，向指定的实际用户发送信号
    - `-t  TERMINAL`: 向指定的终端相关的进程发送信号；
    - `-P pid`: 向此进程的子进程发送信号
    - `-g`：指定进程组；
    - `-o`：仅向找到的最小（起始）进程号发送信号；
    - `-n`：仅向找到的最大（结束）进程号发送信号；


## 3. 实时动态命令
下面介绍的 top, htop，glances 都是能实时查看系统状态的动态命令，有众多快捷键可以控制屏幕显示的内容。htop 是 top 命令的升级版，glance 则是另一款 htop 它们实现的功能类似。

### 3.1 top
`uptime`
- 作用:
    - 显示系统时间、运行时长及平均负载；
    - 过去1分钟、5分钟和15分钟的平均负载；
    - 等待运行的进程队列的长度；
- 注释: 显示内容即 top 命令的首部信息

`top options`
- 作用: display Linux processe
- 选项:
    - `-d #`: 指定刷新时间间隔，默认为3秒；
    - `-b`: 以批次方式显示；
    - `-n #`: 显示多少批次，与 -b 一起使用；
- 快捷键:
    - 排序:
        - `P`: 以占据CPU百分比排序；
        - `M`: 以占据内存百分比排序；
        - `T`: 累积占用CPU时间排序；
    - 首部信息:
        - uptime信息: `l` 命令
        - tasks及cpu信息: `t` 命令
        - CPU分别显示使用数字 `1`
        - 内存信息: m命令
    - 退出命令: `q`
    - 修改刷新时间间隔: `s`
    - 终止指定的进程: `k`
    - 帮助: `h`
    - 显示COMMAND 详细信息: `c`

```
#快捷键: l# top - 18:10:50 up  9:21,  6 users,  load average: 0.73, 0.55, 0.40
#快捷键: t# Tasks: 333 total,   1 running, 332 sleeping,   0 stopped,   0 zombie
#快捷键: 1# %Cpu(s):  5.6 us,  2.3 sy,  0.0 ni, 90.8 id,  0.1 wa,  0.8 hi,  0.4 si,  0.0 st
#快捷键: m# KiB Mem :  8115092 total,   501932 free,  5477676 used,  2135484 buff/cache
           KiB Swap:  2097148 total,  2093124 free,     4024 used.  1486672 avail Mem

           PID USER    PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND          
           4812 tao    20   0 2876852 431600 139652 S   9.5  5.3   49:00.29 atom          
           2150 root   20   0  447256 122816  71820 S   4.6  1.5   13:42.31 X
           4384 tao    20   0 4824324 1.066g  39644 S   3.6 13.8   49:54.58 java
```

`top - 18:10:50 up  9:21,  6 users,  load average: 0.73, 0.55, 0.40`
- 作用: Top 任务队列信息(系统运行状态及平均负载)，与uptime命令结果相同
- 字段:
  - 系统当前时间
  - 系统运行时间，未重启的时间
  - 当前登录用户数
  - 系统负载，即任务队列的平均长度，3个数值分别统计最近1，5，15分钟的系统平均负载
    - 单核CPU情况下，0.00 表示没有任何负荷，1.00表示刚好满负荷，超过1侧表示超负荷，理想值是0.7；
    - 多核CPU负载：CPU核数 * 理想值0.7 = 理想负荷，例如：4核CPU负载不超过2.8何表示没有出现高负载

`Tasks: 333 total,   1 running, 332 sleeping,   0 stopped,   0 zombie`
- 作用: Tasks 进程相关信息
- 字段:
  - 进程总数，例如：Tasks: 231 total, 表示总共运行231个进程
  - 正在运行的进程数，例如：1 running,
  - 睡眠的进程数，例如：230 sleeping,
  - 停止的进程数，例如：0 stopped,
  - 僵尸进程数，例如：0 zombie

`%Cpu(s):  5.6 us,  2.3 sy,  0.0 ni, 90.8 id,  0.1 wa,  0.8 hi,  0.4 si,  0.0 st`
- 作用: CPU 相关信息
- 字段:
  - `us`: 用户空间占用CPU百分比，例如：Cpu(s): 12.7%us,
  - `sy`: 内核空间占用CPU百分比，例如：8.4%sy,
  - `ni`: 用户进程空间内改变过优先级的进程占用CPU百分比，例如：0.0%ni,
  - `id`: 空闲CPU百分比，例如：77.1%id,
  - `wa`: 等待输入输出的CPU时间百分比，例如：0.0%wa,
  - `hi`: CPU服务于硬件中断所耗费的时间总额，例如：0.0%hi,
  - `si`: CPU服务软中断所耗费的时间总额，例如：1.8%si,
  - `st`: Steal time 虚拟机被hypervisor偷去的CPU时间（如果当前处于一个hypervisor下的vm，实际上hypervisor也是要消耗一部分CPU处理时间的）

`KiB Mem :  8115092 total,   501932 free,  5477676 used,  2135484 buff/cache`  
`KiB Swap:  2097148 total,  2093124 free,     4024 used.  1486672 avail Mem`
- 作用: 内存 相关信息
- 字段:
  - 物理内存总量，例如：Mem: 12196436k total,
  - 使用的物理内存总量，例如：12056552k used,
  - 空闲内存总量，例如：Mem: 139884k free,
  - 用作内核缓存的内存量，例如：64564k buffers

字段值含义
- `PID = (Process Id)`: 进程Id；
- `USER = (User Name)`: 进程所有者的用户名；
- `PR = (Priority)`: 优先级
- `NI = (Nice value)`: nice值。负值表示高优先级，正值表示低优先级
- `VIRT = (Virtual Image (kb))`: 进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES
- `RES = (Resident size (kb))`: 进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA
- `SHR = (Shared Mem size (kb))`: 共享内存大小，单位kb
- `S = (Process Status)`: 进程状态。D=不可中断的睡眠状态,R=运行,S=睡眠,T=跟踪/停止,Z=僵尸进程
- `%CPU = (CPU usage)`: 上次更新到现在的CPU时间占用百分比
- `%MEM = (Memory usage (RES))`: 进程使用的物理内存百分比
- `TIME+ = (CPU Time, hundredths)`: 进程使用的CPU时间总计，单位1/100秒
- `PPID = (Parent Process Pid)`: 父进程Id
- `RUSER = (Real user name)`:
- `UID = (User Id)`: 进程所有者的用户id
- `GROUP = (Group Name)`: 进程所有者的组名
- `TTY = (Controlling Tty)`: 启动进程的终端名。不是从终端启动的进程则显示为 ?
- `P = (Last used cpu (SMP))`: 最后使用的CPU，仅在多CPU环境下有意义
- `SWAP = (Swapped size (kb))`: 进程使用的虚拟内存中，被换出的大小，单位kb
- `TIME = (CPU Time)`: 进程使用的CPU时间总计，单位秒
- `CODE = (Code size (kb))`: 可执行代码占用的物理内存大小，单位kb
- `DATA = (Data+Stack size (kb))`: 可执行代码以外的部分(数据段+栈)占用的物理内存大小，单位kb
- `nFLT = (Page Fault count)`: 页面错误次数
- `nDRT = (Dirty Pages count)`: 最后一次写入到现在，被修改过的页面数
- `WCHAN = (Sleeping in Function)`: 若该进程在睡眠，则显示睡眠中的系统函数名
- `Flags = (Task Flags <sched.h>)`: 任务标志，参考 sched.h
- `COMMAND = (Command name/line)`: 命令名/命令行

### 3.2 htop
`htop options`
- 选项:
    - `-d #`: 指定延迟时间间隔；
    - `-u UserName`: 仅显示指定用户的进程；
    - `-s COLUME`: 以指定字段进行排序；
- 子命令:
    - `l`: 显示选定的进程打开的文件列表；
    - `s`: 跟踪选定的进程的系统调用；
    - `t`: 以层级关系显示各进程状态；
    - `a`: 将选定的进程绑定至某指定的CPU核心；


### 3.3 glances命令：
`glances options`
- 作用: 动态的系统状态监控工具，使用类似 top
- 常用选项：
    - `-b`：以Byte为单位显示网上数据速率；
    - `-d`：关闭磁盘I/O模块；
    - `-m`：关闭mount模块；
    - `-n`：关闭network模块；
    - `-t #`：刷新时间间隔；
    - `-1`：每个cpu的相关数据单独显示；
    - `-o {HTML|CSV}`：输出格式；
    - `-f /PATH/TO/SOMEDIR`：设定输出文件的位置；
- C/S模式下运行glances命令：
    - 服务模式：`glances  -s  -B  IPADDR`
        - IPADDR：本机的某地址，用于监听；
    - 客户端模式： `glances  -c  IPADDR`
        - IPADDR：是远程服务器的地址；
    - 附注: C/S 模式下无论是密码还是内容都是明文传输的，容易被截获，glances 不适合 C/S 模式使用
